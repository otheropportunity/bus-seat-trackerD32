<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Bus Seat Tracker Auto Release (15 min)</title>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f0f4f8;
      text-align: center;
      padding: 20px;
    }
    h1 {
      margin-bottom: 20px;
    }
    .bus {
      display: grid;
      grid-template-columns: repeat(5, 80px);
      gap: 10px;
      justify-content: center;
      margin-bottom: 20px;
    }
    .seat, .label {
      width: 80px;
      height: 80px;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      font-size: 16px;
      user-select: none;
      transition: background-color 0.3s ease;
    }
    .seat {
      cursor: pointer;
      color: white;
    }
    .seat.available {
      background-color: #28a745; /* green */
    }
    .seat.pending {
      background-color: #ffc107; /* yellow */
      color: black;
      cursor: wait;
    }
    .seat.taken {
      background-color: #dc3545; /* red */
      cursor: not-allowed;
    }
    .label {
      background-color: #ccc;
      cursor: default;
      color: black;
    }
    #message {
      margin-top: 10px;
      font-weight: bold;
      color: #333;
    }
  </style>
</head>
<body>

<h1>ðŸšŒ Bus Seat Tracker Auto Release (15 min)</h1>

<div class="bus" id="bus"></div>
<div id="message"></div>

<script>
  // ==== Firebase setup ====
  const firebaseConfig = {
    apiKey: "AIzaSyBxkR6Y4ODLqlnsHNv5ZSS6PcPC4CskiVk",
    authDomain: "bus-seat-allocation.firebaseapp.com",
    databaseURL: "https://bus-seat-allocation-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "bus-seat-allocation",
    storageBucket: "bus-seat-allocation.appspot.com",
    messagingSenderId: "103762500529",
    appId: "1:103762500529:web:5c05b8517356656b70bb90"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  // Bus & seats setup
  const busId = "bus-001";
  const busContainer = document.getElementById("bus");
  const messageEl = document.getElementById("message");

  // User ID to identify seat selections
  const userId = localStorage.getItem("userId") || (() => {
    const id = "user-" + Math.random().toString(36).substr(2, 9);
    localStorage.setItem("userId", id);
    return id;
  })();

  // Seat layout array with labels
  const seatLayout = [
    "", "", "", "Driver", "",
    "1", "", "", "", "",
    "2", "3", "", "4", "5",
    "6", "7", "", "8", "9",
    "", "TAPIN/OUT", "", "10", "11",
    "DOOR", "", "", "12", "13",
    "DOOR", "", "", "14", "15",
    "16", "17", "", "18", "19",
    "20", "21", "", "22", "23",
    "24", "25", "", "", "",
    "26", "27", "28", "29", "30"
  ];

  // 15 min timer in ms
  const RELEASE_TIME_MS = 15 * 60 * 1000;

  // For throttling seat update requests
  let isUpdating = false;

  // Render seats UI and attach click handlers
  function renderSeats(busData) {
    busContainer.innerHTML = "";
    const now = Date.now();
    const seatsTakenCount = seatLayout.reduce((count, label) => {
      if (!label || ["Driver","DOOR","TAPIN/OUT"].includes(label)) return count;
      const seatKey = "seat" + label;
      if (busData[seatKey] && busData[seatKey].taken) return count + 1;
      return count;
    }, 0);
    const totalSeats = seatLayout.filter(l => l && !["Driver","DOOR","TAPIN/OUT"].includes(l)).length;

    // Show timer message if all taken and release timer active
    if (busData.allTakenTimestamp) {
      const elapsed = now - busData.allTakenTimestamp;
      if (elapsed < RELEASE_TIME_MS) {
        const remaining = Math.ceil((RELEASE_TIME_MS - elapsed) / 1000);
        messageEl.textContent = `All seats taken. Auto release in ${remaining} seconds.`;
      } else {
        messageEl.textContent = "Releasing all seats now...";
      }
    } else {
      messageEl.textContent = `Seats Taken: ${seatsTakenCount} / ${totalSeats}`;
    }

    for (const label of seatLayout) {
      const el = document.createElement("div");
      if (!label || ["Driver","DOOR","TAPIN/OUT"].includes(label)) {
        el.className = "label";
        el.textContent = label || "";
      } else {
        const seatKey = "seat" + label;
        el.className = "seat";
        el.textContent = label;

        if (busData[seatKey] && busData[seatKey].taken) {
          el.classList.add("taken");
        } else {
          el.classList.add("available");
        }

        el.onclick = () => {
          if (isUpdating) return;
          if (el.classList.contains("taken")) {
            alert("Seat already taken");
            return;
          }
          toggleSeat(seatKey);
        };
      }
      busContainer.appendChild(el);
    }
  }

  // Toggle seat selection in Firebase
  async function toggleSeat(seatKey) {
    if (isUpdating) return;
    isUpdating = true;
    try {
      const seatRef = db.ref(`${busId}/${seatKey}`);
      const snap = await seatRef.get();
      if (snap.exists() && snap.val().taken) {
        alert("Seat just taken by someone else!");
        return;
      }
      // Take the seat (set taken = true and userId + timestamp)
      await seatRef.set({
        taken: true,
        userId,
        timestamp: Date.now()
      });

      // After taking, check if all seats taken to set timestamp for auto-release
      await checkAllTakenAndSetTimer();

    } catch (e) {
      console.error("Error toggling seat:", e);
    } finally {
      isUpdating = false;
    }
  }

  // Check if all seats are taken, and if yes, set a timestamp to start the 15-min release timer
  async function checkAllTakenAndSetTimer() {
    const busRef = db.ref(busId);
    const snap = await busRef.get();
    const data = snap.val() || {};
    const totalSeats = seatLayout.filter(l => l && !["Driver","DOOR","TAPIN/OUT"].includes(l)).length;
    const takenSeats = seatLayout.reduce((count, label) => {
      if (!label || ["Driver","DOOR","TAPIN/OUT"].includes(label)) return count;
      const seatKey = "seat" + label;
      if (data[seatKey] && data[seatKey].taken) return count + 1;
      return count;
    }, 0);

    if (takenSeats === totalSeats) {
      if (!data.allTakenTimestamp) {
        // Set allTakenTimestamp to now
        await busRef.child("allTakenTimestamp").set(Date.now());
      }
    } else {
      // Not all taken - clear any existing timestamp
      if (data.allTakenTimestamp) {
        await busRef.child("allTakenTimestamp").remove();
      }
    }
  }

  // Monitor seats changes & auto release seats after 15 min if all taken
  db.ref(busId).on("value", async (snapshot) => {
    const data = snapshot.val() || {};
    renderSeats(data);

    if (data.allTakenTimestamp) {
      const now = Date.now();
      const elapsed = now - data.allTakenTimestamp;

      if (elapsed >= RELEASE_TIME_MS) {
        // Time to release all seats
        console.log("Releasing all seats after 15 minutes.");

        // Reset all seat taken flags & allTakenTimestamp
        const updates = {};
        for (const label of seatLayout) {
          if (!label || ["Driver","DOOR","TAPIN/OUT"].includes(label)) continue;
          const seatKey = "seat" + label;
          updates[seatKey] = { taken: false };
        }
        updates["allTakenTimestamp"] = null;

        await db.ref(busId).update(updates);
        messageEl.textContent = "All seats released! You can select now.";
      }
    }
  });

  // Initial render with empty seats (will update automatically on db change)
  renderSeats({});
</script>

</body>
</html>
